# /home/andy/infra/ansible/playbook/roles/ghost/tasks/main.yml
---
- debug:
    var: ghost_domain_db

- name: Create Ghost content volume
  community.docker.docker_volume:
    name: "ghost_{{ domain | replace('.', '_') }}_content"

- name: Ensure traefik docker network exists
  community.docker.docker_network:
    name: traefik
    driver: bridge
    attachable: true
    state: present

- name: Ensure backend docker network exists
  community.docker.docker_network:
    name: backend
    driver: bridge
    attachable: true
    state: present

- name: Create MySQL database for Ghost
  community.mysql.mysql_db:
    name: "{{ ghost_domain_db }}"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Create MySQL user for Ghost
  community.mysql.mysql_user:
    name: "{{ ghost_domain_usr }}"
    password: "{{ ghost_domain_pwd }}"
    priv: "{{ ghost_domain_db }}.*:ALL"
    host: "%"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Build Traefik labels
  ansible.builtin.set_fact:
    ghost_router_name: "ghost-{{ domain | replace('.', '-') }}"
    ghost_service_name: "ghost-{{ domain | replace('.', '-') }}"
    ghost_hosts: >-
      {{
        [domain]
        + (traefik.aliases | default([]))
        | unique
      }}

- name: Build Traefik host rule
  ansible.builtin.set_fact:
    ghost_host_rule: >-
      {{
        'Host('
        ~ (ghost_hosts | map('quote') | join(','))
        ~ ')'
      }}

- name: Build Traefik labels map
  ansible.builtin.set_fact:
    ghost_labels: >-
      {{
        {
          'traefik.enable': 'true',
          'traefik.docker.network': 'traefik'
        }
        | combine({
          ('traefik.http.routers.' ~ ghost_router_name ~ '.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '.rule'): ghost_host_rule,
          ('traefik.http.routers.' ~ ghost_router_name ~ '.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.services.' ~ ghost_service_name ~ '.loadbalancer.server.port'): '2368'
        })
      }}

- name: Deploy Ghost container
  community.docker.docker_container:
    name: "ghost-{{ domain | replace('.', '-') }}"
    image: "ghost:6"
    restart_policy: unless-stopped
    networks:
      - name: traefik
      - name: backend
    volumes:
      - "ghost_{{ domain | replace('.', '_') }}_content:/var/lib/ghost/content"
    env:
      # Ghost braucht URL + DB Config
      url: "https://{{ domain }}"
      NODE_ENV: "{{ ghost_env | default('production') }}"
      database__client: "mysql"
      database__connection__host: "ghost-mysql"
      database__connection__user: "{{ ghost_domain_usr }}"
      database__connection__password: "{{ ghost_domain_pwd }}"
      database__connection__database: "{{ ghost_domain_db }}"
    labels: "{{ ghost_labels }}"
