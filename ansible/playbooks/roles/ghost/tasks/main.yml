# /home/andy/infra/ansible/playbook/roles/ghost/tasks/main.yml
---
- debug:
    var: ghost_domain_db

- name: Create Ghost content volume
  community.docker.docker_volume:
    name: "ghost_{{ domain | replace('.', '_') }}_content"

- name: Ensure traefik docker network exists
  community.docker.docker_network:
    name: traefik
    driver: bridge
    attachable: true
    state: present

- name: Ensure backend docker network exists
  community.docker.docker_network:
    name: backend
    driver: bridge
    attachable: true
    state: present

- name: Create MySQL database for Ghost
  community.mysql.mysql_db:
    name: "{{ ghost_domain_db }}"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Create MySQL user for Ghost
  community.mysql.mysql_user:
    name: "{{ ghost_domain_usr }}"
    password: "{{ ghost_domain_pwd }}"
    priv: "{{ ghost_domain_db }}.*:ALL"
    host: "%"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Build Traefik labels
  ansible.builtin.set_fact:
    ghost_router_name: "ghost-{{ domain | replace('.', '-') }}"
    ghost_service_name: "ghost-{{ domain | replace('.', '-') }}"
    ghost_aliases: >-
      {{
        (traefik.aliases | default([], true))
        | difference([domain])
        | unique
      }}

- name: Build Traefik host rules
  ansible.builtin.set_fact:
    ghost_host_rule_primary: "Host(`{{ domain }}`)"
    ghost_host_rule_aliases: >-
      {{
        ghost_aliases
        | map('regex_replace', '^(.*)$', 'Host(`\1`)')
        | join(' || ')
      }}

- name: Build Ghost middleware settings
  ansible.builtin.set_fact:
    ghost_middleware_default: "{{ ghost_traefik_middleware_default | default('') }}"
    ghost_middleware_admin: "{{ ghost_traefik_middleware_admin | default('crowdsec-admin@docker') }}"
    ghost_middleware_api: "{{ ghost_traefik_middleware_api | default('crowdsec-api@docker') }}"
    ghost_middleware_dotghost: "{{ ghost_traefik_middleware_dotghost | default(ghost_traefik_middleware_api | default('crowdsec-api@docker')) }}"
    ghost_middleware_members_api: "{{ ghost_traefik_middleware_members_api | default(ghost_traefik_middleware_api | default('crowdsec-api@docker')) }}"

- name: Build optional Ghost middleware labels
  ansible.builtin.set_fact:
    ghost_labels_middleware_default: "{{ ({ ('traefik.http.routers.' ~ ghost_router_name ~ '.middlewares'): ghost_middleware_default }) if (ghost_middleware_default | length > 0) else {} }}"
    ghost_labels_middleware_admin: "{{ ({ ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.middlewares'): ghost_middleware_admin }) if (ghost_middleware_admin | length > 0) else {} }}"
    ghost_labels_middleware_api: "{{ ({ ('traefik.http.routers.' ~ ghost_router_name ~ '-api.middlewares'): ghost_middleware_api }) if (ghost_middleware_api | length > 0) else {} }}"
    ghost_labels_middleware_dotghost: "{{ ({ ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.middlewares'): ghost_middleware_dotghost }) if (ghost_middleware_dotghost | length > 0) else {} }}"
    ghost_labels_middleware_members_api: "{{ ({ ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.middlewares'): ghost_middleware_members_api }) if (ghost_middleware_members_api | length > 0) else {} }}"

- name: Build optional alias redirect labels
  ansible.builtin.set_fact:
    ghost_labels_alias_redirect: >-
      {{
        {
          ('traefik.http.middlewares.' ~ ghost_router_name ~ '-alias-redirect.redirectregex.regex'): '^https?://[^/]+(?:/(.*))?$',
          ('traefik.http.middlewares.' ~ ghost_router_name ~ '-alias-redirect.redirectregex.replacement'): 'https://' ~ domain ~ '/$1',
          ('traefik.http.middlewares.' ~ ghost_router_name ~ '-alias-redirect.redirectregex.permanent'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.rule'): ghost_host_rule_aliases,
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.priority'): '300',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.middlewares'): ghost_router_name ~ '-alias-redirect',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-alias.service'): 'noop@internal'
        }
        if (ghost_aliases | length > 0) else {}
      }}

- name: Build Traefik labels map
  ansible.builtin.set_fact:
    ghost_labels: >-
      {{
        {
          'traefik.enable': 'true',
          'traefik.docker.network': 'traefik'
        }
        | combine({
          ('traefik.http.routers.' ~ ghost_router_name ~ '.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '.rule'): ghost_host_rule_primary,
          ('traefik.http.routers.' ~ ghost_router_name ~ '.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '.service'): ghost_service_name,

          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.rule'): '(' ~ ghost_host_rule_primary ~ ') && PathPrefix(`/ghost`)',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.priority'): '200',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-admin.service'): ghost_service_name,

          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.rule'): '(' ~ ghost_host_rule_primary ~ ') && PathPrefix(`/ghost/api`)',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.priority'): '220',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-api.service'): ghost_service_name,

          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.rule'): '(' ~ ghost_host_rule_primary ~ ') && PathPrefix(`/.ghost`)',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.priority'): '230',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-dotghost.service'): ghost_service_name,

          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.entrypoints'): 'websecure',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.rule'): '(' ~ ghost_host_rule_primary ~ ') && PathPrefix(`/members/api`)',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.priority'): '210',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.tls'): 'true',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.tls.certresolver'): 'letsEncrypt',
          ('traefik.http.routers.' ~ ghost_router_name ~ '-members-api.service'): ghost_service_name,

          ('traefik.http.services.' ~ ghost_service_name ~ '.loadbalancer.server.port'): '2368'
        })
        | combine(ghost_labels_middleware_default)
        | combine(ghost_labels_middleware_admin)
        | combine(ghost_labels_middleware_api)
        | combine(ghost_labels_middleware_dotghost)
        | combine(ghost_labels_middleware_members_api)
        | combine(ghost_labels_alias_redirect)
      }}

- name: Deploy Ghost container
  community.docker.docker_container:
    name: "ghost-{{ domain | replace('.', '-') }}"
    image: "ghost:{{ ghost_version | default('latest') }}"
    restart_policy: unless-stopped
    recreate: true
    networks:
      - name: traefik
      - name: backend
    volumes:
      - "ghost_{{ domain | replace('.', '_') }}_content:/var/lib/ghost/content"
    # Wichtig: alte /etc/hosts-Overrides (z.B. aus fr√ºheren Deployments) explizit entfernen
    etc_hosts: {}
    env:
      # Ghost braucht URL + DB Config
      url: "https://{{ domain }}"
      NODE_ENV: "{{ ghost_env | default('production') }}"
      database__client: "mysql"
      database__connection__host: "ghost-mysql"
      database__connection__user: "{{ ghost_domain_usr }}"
      database__connection__password: "{{ ghost_domain_pwd }}"
      database__connection__database: "{{ ghost_domain_db }}"
      mail__transport: "SMTP"
      mail__options__host: "{{ ghost_ses_smtp_host | default('email-smtp.eu-central-1.amazonaws.com') }}"
      mail__options__port: "{{ ghost_ses_smtp_port | default(587) | string }}"
      mail__options__secure: "{{ ghost_ses_smtp_secure | default(false) | bool | lower }}"
      mail__options__requireTLS: "{{ ghost_ses_smtp_requireTLS | default(true) | bool | lower }}"
      mail__options__auth__user: "{{ ghost_ses_smtp_user }}"
      mail__options__auth__pass: "{{ ghost_ses_smtp_password }}"
      mail__from: "{{ ghost_ses_from | default('noreply@' ~ domain) }}"
    labels: "{{ ghost_labels }}"
