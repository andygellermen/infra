# /home/andy/infra/ansible/playbook/ghost/tasks/main.yml
---
- name: Create Ghost content volume
  docker_volume:
    name: "ghost_{{ traefik.domain | replace('.', '_') }}_content"

- name: Create MySQL database for Ghost
  community.mysql.mysql_db:
    name: "{{ ghost_mysql.db_name }}"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Create MySQL user for Ghost
  community.mysql.mysql_user:
    name: "{{ ghost_mysql.db_user }}"
    password: "{{ ghost_mysql.db_password }}"
    priv: "{{ ghost_mysql.db_name }}.*:ALL"
    host: "%"
    state: present
    login_user: root
    login_password: "{{ mysql_root_password }}"
    login_host: 127.0.0.1

- name: Deploy Ghost container
  docker_container:
    name: "ghost-{{ traefik.domain | replace('.', '-') }}"
    image: "ghost:6"
    restart_policy: unless-stopped
    networks:
      - name: traefik
    volumes:
      - "ghost_{{ traefik.domain | replace('.', '_') }}_content:/var/lib/ghost/content"
    env:
      # Ghost braucht URL + DB Config
      url: "https://{{ traefik.domain }}"
      NODE_ENV: "{{ ghost_env | default('production') }}"
      database__client: "mysql"
      database__connection__host: "mysql"
      database__connection__user: "{{ ghost_db_user }}"
      database__connection__password: "{{ ghost_db_password }}"
      database__connection__database: "{{ ghost_db_name }}"

    labels:
      "traefik.enable": "true"
      "traefik.docker.network": "traefik"

      # Router
      "traefik.http.routers.ghost-{{ traefik.domain | replace('.', '-') }}.entrypoints": "websecure"
      "traefik.http.routers.ghost-{{ traefik.domain | replace('.', '-') }}.tls": "true"
      "traefik.http.routers.ghost-{{ traefik.domain | replace('.', '-') }}.tls.certresolver": "letsEncrypt"

      # âœ… Host-Regel: Hauptdomain + alle Aliase
      "traefik.http.routers.ghost-{{ traefik.domain | replace('.', '-') }}.rule": >-
        {{ ([traefik.domain] + (traefik.aliases | default([])))
           | map('regex_replace', '^(.*)$', 'Host(`\\1`)')
           | join(' || ')
        }}

      # Service
      "traefik.http.services.ghost-{{ traefik.domain | replace('.', '-') }}.loadbalancer.server.port": "2368"
